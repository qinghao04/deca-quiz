<div class="creator-layout">
  <form class="creator-main space-y-8" [formGroup]="form" (ngSubmit)="submit()">
    <section class="card-surface rounded-3xl p-6 shadow-glow">
      <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
          <h2 class="text-xl font-semibold text-white">Create a quiz in minutes</h2>
          <p class="mt-1 text-sm text-slate-300">Build in three short steps and launch instantly.</p>
        </div>
        <div class="stepper">
          <span class="step-pill is-active">1 Title</span>
          <span class="step-pill">2 Questions</span>
          <span class="step-pill">3 Launch</span>
        </div>
      </div>

      <div class="mt-6">
        <div class="section-head">
          <span class="section-icon">T</span>
          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-slate-400">Step 1</p>
            <h3 class="text-base font-semibold text-white">Quiz title</h3>
          </div>
        </div>
        <input
          class="input-field mt-4 w-full rounded-2xl border px-4 py-3 text-white focus:border-cyan-400 focus:outline-none"
          formControlName="title"
          [ngClass]="{ 'input-error': form.get('title')?.touched && form.get('title')?.hasError('required') }"
          placeholder="Midnight Trivia Round"
        />
        <p
          *ngIf="form.get('title')?.touched && form.get('title')?.hasError('required')"
          class="mt-2 text-xs text-rose-300"
        >
          Quiz title is required.
        </p>
      </div>
    </section>

    <section class="card-surface rounded-3xl p-6">
      <div class="section-head">
        <span class="section-icon">U</span>
        <div>
          <p class="text-xs uppercase tracking-[0.2em] text-slate-400">Step 2</p>
          <h3 class="text-base font-semibold text-white">Add questions</h3>
          <p class="text-xs text-slate-400">Manual entry or file upload.</p>
        </div>
        <div class="ml-auto text-xs text-slate-400">{{ questionProgressLabel }}</div>
      </div>

      <div
        class="upload-drop mt-5 rounded-3xl border border-dashed border-slate-600 p-6 text-center"
        (drop)="onDrop($event)"
        (dragover)="onDragOver($event)"
      >
        <p class="text-sm text-slate-300">Drop a PDF, CSV, or TXT here, or</p>
        <label
          class="mt-3 inline-flex cursor-pointer items-center gap-2 rounded-full border border-cyan-400 px-4 py-2 text-sm font-medium text-cyan-200"
        >
          <input type="file" class="hidden" accept=".pdf,.csv,.txt" (change)="onFilePicked($event)" />
          Upload file
        </label>
        <p class="mt-2 text-xs text-slate-400">We parse up to 50 questions from supported files.</p>
        <p *ngIf="isUploading" class="mt-3 text-sm text-cyan-200">Parsing...</p>
        <p *ngIf="uploadError" class="mt-3 text-sm text-rose-300">{{ uploadError }}</p>

        <div class="mt-4 border-t border-slate-800 pt-4 text-left">
          <label class="text-xs text-slate-400">Google Drive share link</label>
          <div class="mt-2 flex flex-col gap-2 sm:flex-row">
            <input
              class="input-field w-full rounded-2xl border px-4 py-2 text-sm text-white focus:border-cyan-400 focus:outline-none"
              [formControl]="driveLink"
              placeholder="https://drive.google.com/file/d/FILE_ID/view"
            />
            <button
              type="button"
              class="rounded-full border border-cyan-400 px-4 py-2 text-sm font-medium text-cyan-200"
              [disabled]="isImporting"
              (click)="importFromDrive()"
            >
              {{ isImporting ? 'Importing...' : 'Import from Drive' }}
            </button>
          </div>
          <p class="mt-2 text-xs text-slate-400">
            Share the file as "Anyone with the link" and use PDF, CSV, or TXT.
          </p>
          <p *ngIf="importError" class="mt-2 text-sm text-rose-300">{{ importError }}</p>
        </div>
      </div>

      <div *ngIf="showFileHelp" class="mt-4 rounded-2xl border border-slate-700 bg-slate-950/40 p-4 text-xs text-slate-300">
        <p>CSV: Question, Option 1, Option 2, ..., CorrectIndex (optional, 0-based).</p>
        <p class="mt-2">TXT/PDF: One question per line using | separators, e.g. Question | Option 1 | Option 2 | 0.</p>
        <p class="mt-2">If CorrectIndex is omitted, the first option is used.</p>
      </div>

      <div class="mt-6 space-y-4" formArrayName="questions">
        <div
          class="question-card card-surface rounded-3xl p-6"
          *ngFor="let questionGroup of questions.controls; let i = index"
          [formGroupName]="i"
          [id]="'question-' + i"
          (focusin)="setActiveQuestion(i)"
          [ngClass]="{ 'is-active': activeQuestionIndex === i }"
        >
          <div class="flex items-center justify-between">
            <h4 class="text-lg font-semibold text-white">Question {{ i + 1 }}</h4>
            <button
              type="button"
              class="text-xs text-slate-400 hover:text-rose-300"
              (click)="removeQuestion(i)"
            >
              Remove
            </button>
          </div>
          <textarea
            class="input-field mt-3 w-full rounded-2xl border px-4 py-3 text-white focus:border-cyan-400 focus:outline-none"
            formControlName="question"
            [ngClass]="{ 'input-error': questionGroup.get('question')?.touched && questionGroup.get('question')?.hasError('required') }"
            rows="2"
            placeholder="What is the capital of France?"
          ></textarea>
          <p
            *ngIf="questionGroup.get('question')?.touched && questionGroup.get('question')?.hasError('required')"
            class="mt-2 text-xs text-rose-300"
          >
            Question text is required.
          </p>

          <div class="mt-4 space-y-3" formArrayName="options">
            <div
              class="option-row flex items-center gap-3"
              *ngFor="let option of optionsAt(i).controls; let j = index"
            >
              <label class="inline-flex items-center gap-2 text-xs text-slate-300">
                <input
                  type="radio"
                  class="option-radio"
                  formControlName="correctIndex"
                  [value]="j"
                  [attr.name]="'correct-' + i"
                />
                Correct
              </label>
              <div class="flex-1">
                <input
                  class="input-field w-full rounded-2xl border px-4 py-2 text-white focus:border-cyan-400 focus:outline-none"
                  [formControlName]="j"
                  [ngClass]="{ 'input-error': option.touched && option.hasError('required') }"
                  placeholder="Option {{ j + 1 }}"
                />
                <p *ngIf="option.touched && option.hasError('required')" class="mt-1 text-xs text-rose-300">
                  Option is required.
                </p>
              </div>
              <button
                type="button"
                class="text-xs text-slate-400 hover:text-rose-300"
                (click)="removeOption(i, j)"
              >
                Remove
              </button>
            </div>
            <button
              type="button"
              class="add-option inline-flex items-center gap-2 text-xs text-cyan-200"
              (click)="addOption(i)"
            >
              + Add option
            </button>
          </div>
        </div>

        <button
          type="button"
          class="add-question rounded-full border border-slate-700 px-4 py-2 text-sm text-slate-200 hover:border-cyan-400"
          (click)="addQuestion()"
        >
          + Add question
        </button>
        <p *ngIf="addQuestionError" class="mt-2 text-sm text-rose-300">{{ addQuestionError }}</p>
      </div>
    </section>

    <section class="launch-bar">
      <div class="launch-inner">
        <div class="section-head">
          <span class="section-icon">L</span>
          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-slate-400">Step 3</p>
            <h3 class="text-base font-semibold text-white">Review & launch</h3>
          </div>
        </div>
        <div class="checklist">
          <div class="check-item">
            <span class="check-dot" [ngClass]="{ done: form.get('title')?.valid }"></span>
            <span>Title added</span>
          </div>
          <div class="check-item">
            <span class="check-dot" [ngClass]="{ done: questions.length > 0 }"></span>
            <span>At least one question</span>
          </div>
          <div class="check-item">
            <span class="check-dot" [ngClass]="{ done: canLaunch }"></span>
            <span>Options filled</span>
          </div>
        </div>
        <div class="launch-actions">
          <button
            type="submit"
            class="inline-flex items-center gap-2 rounded-full bg-cyan-400 px-8 py-3 text-sm font-semibold text-slate-900 shadow-glow"
            [disabled]="isSubmitting || !canLaunch"
          >
            <span
              *ngIf="isSubmitting"
              class="h-4 w-4 animate-spin rounded-full border-2 border-slate-900/30 border-t-slate-900"
            ></span>
            {{ isSubmitting ? 'Creating...' : 'Launch Quiz' }}
          </button>
          <p *ngIf="submitError" class="text-sm text-rose-300">{{ submitError }}</p>
          <p *ngIf="submitAttempted && form.invalid && !submitError" class="text-sm text-rose-300">
            Please fill in all required fields.
          </p>
        </div>
      </div>
    </section>
  </form>

  <aside class="creator-sidebar space-y-6">
    <div class="card-surface rounded-3xl p-6">
      <h3 class="text-lg font-semibold text-white">Host Toolkit</h3>
      <p class="mt-2 text-sm text-slate-300">Keep this tab open to run the live leaderboard.</p>
      <div *ngIf="createdQuiz" class="mt-4 space-y-3">
        <div class="rounded-2xl border border-slate-700 bg-slate-900/50 p-4">
          <p class="text-xs uppercase text-slate-400">Quiz Code</p>
          <p class="mt-1 text-2xl font-semibold tracking-widest text-white">{{ createdQuiz.quizCode }}</p>
        </div>
        <div class="rounded-2xl border border-slate-700 bg-slate-900/50 p-4">
          <p class="text-xs uppercase text-slate-400">Join Link</p>
          <p class="mt-1 break-all text-sm text-cyan-200">{{ joinLink }}</p>
        </div>
        <a
          class="inline-flex items-center justify-center rounded-full border border-orange-400 px-4 py-2 text-sm text-orange-200"
          [routerLink]="['/leaderboard', createdQuiz.quizCode]"
          >Open Live Leaderboard</a
        >
      </div>
      <p *ngIf="!createdQuiz" class="mt-4 text-sm text-slate-400">
        Launch a quiz to reveal the join link and scoreboard.
      </p>
    </div>

    <div class="card-surface rounded-3xl p-6">
      <h4 class="text-sm font-semibold text-slate-200">Tips</h4>
      <ul class="mt-3 space-y-2 text-xs text-slate-400">
        <li>Keep questions short for better mobile pacing.</li>
        <li>10-minute auto-wipe keeps data temporary.</li>
        <li>Room limit enforces the 20-participant cap.</li>
      </ul>
    </div>
  </aside>
</div>
